<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Microsoft Connectivity Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --success: #22c55e;
      --fail: #ef4444;
      --warn: #f59e0b;
      --dns: #38bdf8;
      --tcp: #fb7185;
      --tls: #a78bfa;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell;
      background: linear-gradient(135deg, #020617, #0f172a);
      color: var(--text);
    }

    header {
      padding: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    header i {
      font-size: 2rem;
      color: #60a5fa;
    }

    h1 { margin: 0; font-size: 1.8rem; }

    .container { padding: 1.5rem; max-width: 1400px; margin: auto; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
    }

    .card {
      background: linear-gradient(180deg, #020617, #020617);
      border: 1px solid #1f2933;
      border-radius: 14px;
      padding: 1.2rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    .card h2 {
      font-size: 1rem;
      margin: 0 0 .5rem;
      color: var(--muted);
    }

    .metric {
      font-size: 2rem;
      font-weight: 700;
    }

    .success { color: var(--success); }
    .fail { color: var(--fail); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      padding: .6rem;
      text-align: left;
      font-size: .85rem;
    }

    th {
      color: var(--muted);
      border-bottom: 1px solid #1f2937;
    }

    tr {
      border-bottom: 1px solid #020617;
    }

    tr:hover {
      background: #020617;
    }

    .badge {
      padding: .2rem .5rem;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: .3rem;
    }

    .DNS { background: rgba(56,189,248,.15); color: var(--dns); }
    .TCP { background: rgba(251,113,133,.15); color: var(--tcp); }
    .TLS { background: rgba(167,139,250,.15); color: var(--tls); }
    .TLS_INSPECTION { background: rgba(245,158,11,.15); color: var(--warn); }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
      font-size: .8rem;
    }

    input[type=file] {
      background: #020617;
      color: var(--text);
      border: 1px solid #1f2937;
      padding: .5rem;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<header>
  <i class="fa-solid fa-network-wired"></i>
  <h1>Microsoft Connectivity Report</h1>
</header>

<div class="container">

  <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
    <input type="file" id="fileInput" accept="application/json" />
    <label style="display:flex; gap:.4rem; align-items:center; font-size:.85rem; color:var(--muted);">
      <input type="checkbox" id="ipv6Toggle" checked />
      Show IPv6 results
    </label>
  </div>

  <div class="grid" id="summary"></div>

  <div class="card">
    <h2>Detailed Results</h2>
    <div style="display:flex; gap:1rem; margin-bottom:1rem; flex-wrap:wrap;">
      <input id="searchBox" placeholder="Search service / target" style="flex:1; background:#020617; color:var(--text); border:1px solid #1f2937; padding:.5rem; border-radius:8px;">
      <select id="failureFilter" style="background:#020617; color:var(--text); border:1px solid #1f2937; padding:.5rem; border-radius:8px;">
        <option value="">All failures</option>
        <option value="DNS">DNS</option>
        <option value="TCP">TCP</option>
        <option value="TLS">TLS</option>
        <option value="TLS_INSPECTION">TLS Inspection</option>
      </select>
      <button id="exportCsv" style="background:#2563eb; color:white; border:none; padding:.5rem .8rem; border-radius:8px; cursor:pointer;">Export CSV</button>
    </div>
    <table id="resultsTable">
      <thead>
        <tr>
          <th>Service</th>
          <th>Target</th>
          <th>Port</th>
          <th>Status</th>
          <th>Latency</th>
          <th>Failure</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<footer>
  Generated from Microsoft Endpoint Connectivity Tests
</footer>

<script>
const fileInput = document.getElementById('fileInput');
const ipv6Toggle = document.getElementById('ipv6Toggle');
const searchBox = document.getElementById('searchBox');
const failureFilter = document.getElementById('failureFilter');
const exportCsvBtn = document.getElementById('exportCsv');
const summaryDiv = document.getElementById('summary');
const tableBody = document.querySelector('#resultsTable tbody');

let loadedData = null;

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      loadedData = JSON.parse(reader.result);
      render();
    } catch (e) {
      alert('Invalid JSON file');
      console.error(e);
    }
  };
  reader.readAsText(file);
});

function render() {
  if (!loadedData) return;

  summaryDiv.innerHTML = '';
  tableBody.innerHTML = '';

  const s = loadedData.summary;

  addCard('Total Tests', s.total_tests, 'fa-list');
  addCard('Success', s.success, 'fa-circle-check', 'success');
  addCard('Failed', s.failed, 'fa-circle-xmark', 'fail');
  addCard('Avg Latency', s.average_time_ms + ' ms', 'fa-clock');

  if (s.failures_by_type) {
    for (const [k, v] of Object.entries(s.failures_by_type)) {
      addCard(`${k} Failures`, v, 'fa-triangle-exclamation');
    }
  }

  loadedData.results
    .filter(matchesFilters)
    .forEach(r => {
      const tlsInfo = r.tls_details
        ? `TLS ${r.tls_details.version}
Cipher: ${r.tls_details.cipher}
Issuer: ${r.tls_details.issuer}
Expires in: ${r.tls_details.expires_in_days} days`
        : 'No TLS data';

      const timingInfo = r.timings
        ? Object.entries(r.timings)
            .map(([k,v]) => `${k}: ${v} ms`)
            .join('\n')
        : '';

      const failureTooltip = r.failure_type
        ? `
Error code: ${r.error_code}
Error: ${r.error}
Cause: ${r.probable_cause}
Action: ${r.recommended_action}
`
        : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.service}</td>
        <td>${r.target}</td>
        <td>${r.port ?? '-'}</td>
        <td title="${r.required ? 'Required for service' : 'Optional endpoint'}">
          ${r.required ? '❗' : '–'}
        </td>
        <td>${r.success ? '✅' : '❌'}</td>
        <td title="${timingInfo}">
          ${r.timings?.total_ms ?? '-'} ms
        </td>
        <td title="${r.retry_outcome}">
          ${r.retry_outcome?.replaceAll('_',' ') ?? '-'}
        </td>
        <td>
          ${r.failure_type
            ? `<span class="badge ${r.failure_type}" title="${failureTooltip}">
                ${r.failure_type}
              </span>`
            : `<span class="badge" title="${tlsInfo}">OK</span>`
          }
        </td>
      `;
      tableBody.appendChild(tr);
    });
}

function isIPv6(target) {
  return typeof target === 'string' && target.includes(':');
}

function matchesFilters(r) {
  if (!ipv6Toggle.checked && isIPv6(r.target)) return false;

  const q = searchBox.value.toLowerCase();
  if (q && !(r.service.toLowerCase().includes(q) || r.target.toLowerCase().includes(q))) {
    return false;
  }

  if (failureFilter.value && r.failure_type !== failureFilter.value) return false;

  return true;
}

searchBox.addEventListener('input', render);
failureFilter.addEventListener('change', render);
ipv6Toggle.addEventListener('change', render);

exportCsvBtn.addEventListener('click', () => {
  if (!loadedData) return;

  const rows = loadedData.results.filter(matchesFilters);
  if (!rows.length) return;

  const header = Object.keys(rows[0]);
  const csv = [
    header.join(','),
    ...rows.map(r =>
      header.map(h => JSON.stringify(r[h] ?? '')).join(',')
    )
  ].join('\n');

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'filtered_results.csv';
  a.click();

  URL.revokeObjectURL(url);
});

function addCard(label, value, icon, cls = '') {
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <h2><i class="fa-solid ${icon}"></i> ${label}</h2>
    <div class="metric ${cls}">${value}</div>
  `;
  summaryDiv.appendChild(card);
}
</script>

</body>
</html>
